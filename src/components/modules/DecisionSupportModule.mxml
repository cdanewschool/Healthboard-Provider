<?xml version="1.0" encoding="utf-8"?>
<s:VGroup 
	xmlns:fx="http://ns.adobe.com/mxml/2009" 
	xmlns:s="library://ns.adobe.com/flex/spark" 
	xmlns:mx="library://ns.adobe.com/flex/mx" 
	xmlns:components="components.*" 
	xmlns:general="components.general.*" 
	xmlns:ASclasses="ASclasses.*"
	creationComplete="init()">
	
	<fx:Declarations>
		<!-- Place non-visual elements (e.g., services, value objects) here -->
	</fx:Declarations>
	
	<fx:Script>
		<![CDATA[
			import components.general.MainLinkButton;
			import components.popups.decisionsupport.ManageRiskFactorsPopup;
			import components.popups.decisionsupport.NotifyPopup;
			import components.tabs.DecisionSupportRiskFactorDetails;
			
			import controllers.DecisionSupportController;
			import controllers.MainController;
			
			import enum.DateRanges;
			import enum.RiskLevel;
			
			import events.ApplicationEvent;
			import events.MessageEvent;
			import events.TeamAppointmentEvent;
			
			import models.Appointment;
			import models.PatientModel;
			import models.TeamAppointmentsModel;
			import models.modules.MessagesModel;
			import models.modules.decisionsupport.DecisionSupportModel;
			import models.modules.decisionsupport.RiskFactor;
			import models.modules.decisionsupport.RiskFactorUpdate;
			
			import mx.controls.Image;
			import mx.managers.PopUpManager;
			
			import styles.ChartStyles;
			
			private var _patient:PatientModel;
			
			private var _riskFactor:RiskFactor;
			private var dirty:Boolean;
			
			[Bindable] public var controller:DecisionSupportController = MainController(AppProperties.getInstance().controller).decisionSupportController as DecisionSupportController;
			[Bindable] public var model:DecisionSupportModel = controller.model as DecisionSupportModel;
			
			[Bindable] private var chartStyles:ChartStyles = AppProperties.getInstance().controller.model.chartStyles;
			
			private var appointmentsModel:TeamAppointmentsModel = TeamAppointmentsModel( MainController( AppProperties.getInstance().controller ).teamAppointmentsController.model );
			private var messagesModel:MessagesModel = MessagesModel( MainController( AppProperties.getInstance().controller ).messagesController.model );
			
			[Bindable] [Embed("/images/messagesUrgentSmall.png")] public var redDot:Class;
			
			[Bindable] public function get riskFactor():RiskFactor { return _riskFactor; }

			private var managePopup:ManageRiskFactorsPopup;
			private var notifyPopup:NotifyPopup;
			
			public function set riskFactor(value:RiskFactor):void
			{
				_riskFactor = value;
				
				invalidateProperties();
			}

			[Bindable]
			public function get patient():PatientModel { return _patient; }
			
			public function set patient(value:PatientModel):void
			{
				_patient = value;
				
				dirty = true;
				
				invalidateProperties();
			}
			
			override protected function commitProperties():void
			{
				super.commitProperties();
				
				var linkButton:MainLinkButton;
				var linkGroup:HGroup;
				
				if( patient 
					&& dirty )
				{
					var date:Date;
					
					var bullet:Image;
					
					for each(var riskFactor:RiskFactor in patient.riskFactorGroups)
					{
						var currentUpdate:RiskFactorUpdate = riskFactor.updates && riskFactor.updates.length ? riskFactor.updates.getItemAt(0) as RiskFactorUpdate : null;
						
						linkGroup = new HGroup();
						linkGroup.verticalAlign = "middle";
						
						bullet = new Image();
						bullet.source = redDot;
						bullet.visible = currentUpdate && currentUpdate.riskLevel == RiskLevel.HIGH;
						linkGroup.addElement( bullet );
						
						linkButton = new MainLinkButton();
						linkButton.data = riskFactor;
						linkButton.label = riskFactor.name + ' (' + riskFactor.types.length + ')';
						linkButton.addEventListener( MouseEvent.CLICK, onRiskFactorClick );
						linkGroup.addElement( linkButton );
						
						riskFactorLinks.addElement( linkGroup );
						
						var details:DecisionSupportRiskFactorDetails = new DecisionSupportRiskFactorDetails();
						details.patient = patient;
						details.riskFactor = riskFactor;
						viewStack.addChild( details );
					}
					
					dirty = false;
				}
				
				for(var i:int=0;i<riskFactorLinks.numElements;i++)
				{
					linkGroup = riskFactorLinks.getElementAt(i) as HGroup;
					linkButton = linkGroup.getElementAt(1) as MainLinkButton;
					
					var active:Boolean = linkButton.data == this.riskFactor;
					
					linkButton.styleName = (active ? "linkButtonStyle5 bold" : "linkButtonStyle6");
				}
				
				if( this.riskFactor )
				{
					viewStack.selectedIndex = 1 + patient.riskFactorGroups.getItemIndex( this.riskFactor );
				}
				else
				{
					viewStack.selectedIndex = 0;
				}
				
				allRisks.styleName = (!this.riskFactor ? "linkButtonStyle5 bold" : "linkButtonStyle1");
			}
			
			private var dateRange:String = DateRanges.MONTH_THREE;
			
			private function setDateRange(range:String=null):void
			{
				dateRange = range;
				
				updateDateRange();
			}
			
			private function updateDateRange():void 
			{
				var today:Date = AppProperties.getInstance().controller.model.today;
				
				if(dateRange == DateRanges.WEEK) 
				{
					model.minDate = new Date(today.getTime() - 1000*60*60*24*7);
				}
				else if(dateRange == DateRanges.MONTH) 
				{
					model.minDate = new Date(today.getTime() - 1000*60*60*24*30);
				}
				else if(dateRange == DateRanges.MONTH_THREE) 
				{
					model.minDate = new Date(today.getTime() - 1000*60*60*24*91);
				}
				else if(dateRange == DateRanges.YEAR) 
				{
					model.minDate = new Date(today.getTime() - 1000*60*60*24*365.24);
				}
				else if(dateRange == DateRanges.YEAR_THREE) 
				{
					model.minDate = new Date(today.getTime() - 1000*60*60*24*1095.73);
				}
				else
				{
					model.minDate = new Date(2011,7,26);
				}
			}
			
			private function onRiskFactorClick(event:MouseEvent):void
			{
				var linkButton:MainLinkButton = event.currentTarget as MainLinkButton;
				
				riskFactor = linkButton.data as RiskFactor;
			}
			
			private function onNotifyClick(event:MouseEvent):void
			{
				notifyPopup = new NotifyPopup();
				notifyPopup.patient = patient;
				notifyPopup.addEventListener( MessageEvent.ADD, addMessage );
				notifyPopup.addEventListener( TeamAppointmentEvent.ADD, addAppointment );
				
				PopUpManager.addPopUp( notifyPopup, DisplayObject(mx.core.FlexGlobals.topLevelApplication) );
				PopUpManager.centerPopUp( notifyPopup );
			}
			
			private function addMessage( event:MessageEvent ):void
			{
				//messagesModel.addAppointment( notifyPopup.appointment );
				
				var evt:ApplicationEvent = new ApplicationEvent( ApplicationEvent.SHOW_STATUS, true );
				evt.data = "Your message has been added";
				dispatchEvent( evt );
			}
			
			private function addAppointment( event:TeamAppointmentEvent ):void
			{
				var appointment:Appointment = notifyPopup.appointment;
				appointment.provider = MainController(AppProperties.getInstance().controller).user;
				
				appointmentsModel.addAppointment( appointment );
				
				var evt:ApplicationEvent = new ApplicationEvent( ApplicationEvent.SHOW_STATUS, true );
				evt.data = "Your appointment has been added";
				dispatchEvent( evt );
			}
			
			private function onManageClick(event:MouseEvent):void
			{
				managePopup = new ManageRiskFactorsPopup();
				managePopup.patient = patient;
				
				PopUpManager.addPopUp( managePopup, DisplayObject(mx.core.FlexGlobals.topLevelApplication) );
				PopUpManager.centerPopUp( managePopup );
			}
			
			private function onExportClick(event:MouseEvent):void
			{
				dispatchEvent( new ApplicationEvent( ApplicationEvent.SHOW_STATUS, true, false, 'Your file has been exported') )
			}
			
			private function init():void
			{
				
			}
		]]>
	</fx:Script>
	
	<s:HGroup width="100%" gap="0">
		
		<s:VGroup width="100%" paddingTop="15" paddingLeft="7" gap="7" styleName="whiteText13">
			
			<general:MainLinkButton id="allRisks" label="ALL RISKS" styleName="linkButtonStyle5 bold" paddingLeft="-4" paddingBottom="3" click="riskFactor=null" />
			
			<s:VGroup id="riskFactorLinks" gap="7" />
			
		</s:VGroup>
		
		<s:BorderContainer width="823" borderColor="0xBDBCBC" backgroundAlpha="0">
			
			<s:layout>
				<s:VerticalLayout gap="0" />
			</s:layout>
			
			<s:BorderContainer height="37" width="100%" backgroundColor="0x706F6F" borderAlpha="0">
				
				<s:layout>
					<s:HorizontalLayout verticalAlign="middle" paddingLeft="10" paddingRight="9"/>
				</s:layout>
				
				<s:Button label="Notify" styleName="buttonText" height="24" click="onNotifyClick(event)" />
				<s:Button label="Manage Risk Factors" styleName="buttonText" height="24" click="onManageClick(event)" visible="{riskFactor!=null}" includeInLayout="{riskFactor!=null}" />
				<s:Button label="Export" styleName="buttonText" height="24" click="onExportClick(event)" visible="{riskFactor!=null}" includeInLayout="{riskFactor!=null}" />
				
				<s:Spacer width="100%" />
				
				<s:HGroup horizontalAlign="right" color="0xFFFFFF" gap="2">
					
					<s:Label text="Time Range:" paddingTop="6" />
					
					<general:customLinkButton label="{DateRanges.DAY}" click="setDateRange(DateRanges.DAY)" toggle="true" selected="{model.dateRange==DateRanges.DAY}" toggleBackgroundColor="0x4A4A49" skin="skins.general.MyLinkButtonSkin" />
					<general:customLinkButton label="{DateRanges.WEEK}" click="setDateRange(DateRanges.WEEK)" toggle="true" selected="{model.dateRange==DateRanges.WEEK}" toggleBackgroundColor="0x4A4A49" skin="skins.general.MyLinkButtonSkin" />
					<general:customLinkButton label="{DateRanges.MONTH}" click="setDateRange(DateRanges.MONTH)" toggle="true" selected="{model.dateRange==DateRanges.MONTH}" toggleBackgroundColor="0x4A4A49" skin="skins.general.MyLinkButtonSkin" />
					<general:customLinkButton label="{DateRanges.MONTH_THREE}" click="setDateRange(DateRanges.MONTH_THREE)" selected="{model.dateRange==DateRanges.MONTH_THREE}" toggle="true" toggleBackgroundColor="0x4A4A49" skin="skins.general.MyLinkButtonSkin" />
					<general:customLinkButton label="{DateRanges.YEAR}" click="setDateRange(DateRanges.YEAR)" toggle="true" selected="{model.dateRange==DateRanges.YEAR}" toggleBackgroundColor="0x4A4A49" skin="skins.general.MyLinkButtonSkin" />
					<general:customLinkButton label="{DateRanges.YEAR_THREE}" click="setDateRange(DateRanges.YEAR_THREE)" selected="{model.dateRange==DateRanges.YEAR_THREE}" toggle="true" toggleBackgroundColor="0x4A4A49" skin="skins.general.MyLinkButtonSkin" />
					<general:customLinkButton label="All" click="setDateRange()" selected="{model.dateRange==null}"  toggle="true" toggleBackgroundColor="0x4A4A49" skin="skins.general.MyLinkButtonSkin" />
					<general:customLinkButton id="btnMedCustom" label="Custom" />
					
				</s:HGroup>
				
			</s:BorderContainer>
			
			<s:Line xFrom="0" xTo="822">
				<s:stroke>
					<s:SolidColorStroke color="#3F3E3D"/>
				</s:stroke>
			</s:Line>
			
			<mx:ViewStack 
				id="viewStack" 
				width="825" 
				backgroundColor="0x4A4A49" borderVisible="false" borderStyle="solid" cornerRadius="2" 
				x="0" y="22" resizeToContent="true">
				
				<s:NavigatorContent>
					
					<s:VGroup width="100%">
						
						<s:HGroup width="100%" color="0xFFFFFF" height="31" horizontalAlign="right" verticalAlign="middle">
							
							<s:Line xFrom="0" xTo="24">
								<s:stroke>
									<s:SolidColorStroke color="0x86888A" weight="2" alpha=".5"/>
								</s:stroke>
							</s:Line>
							
							<s:Label text="Projected" />
							
							<mx:Legend direction="horizontal" color="0xFFFFFF" fontFamily="myMyriadNoCFF" verticalAlign="bottom" paddingRight="14" paddingLeft="15" paddingTop="6">
								<mx:LegendItem label="Patient Entry" fontSize="12" fontWeight="normal" legendMarkerRenderer="mx.charts.renderers.CircleItemRenderer" markerAspectRatio="1" markerHeight="12" markerWidth="12" fill="{chartStyles.colorVitalSignsPatient}"  stroke="{chartStyles.whiteStroke}" />
								<mx:LegendItem label="Provider Entry" fontSize="12" fontWeight="normal" legendMarkerRenderer="mx.charts.renderers.BoxItemRenderer" markerAspectRatio="1" markerHeight="12" markerWidth="12" fill="{chartStyles.colorVitalSignsProvider}" stroke="{chartStyles.whiteStroke}" />
							</mx:Legend>
							
						</s:HGroup>
						
						<ASclasses:RowColorDataGrid 
							id="overview" 
							width="100%" height="100%" 
							dataProvider="{patient.riskFactorGroups}"
							dropIndicatorSkin="skins.general.myDropIndicatorSkin"
							color="0xFFFFFF" alternatingItemColors="[0x3C3C3B,0x4A4A49]" verticalAlign="middle"
							selectionDuration="2000" useRollOver="false" 
							headerHeight="0" selectable="false"
							borderVisible="false" verticalGridLines="false" horizontalGridLines="false" horizontalSeparatorSkin="{null}"
							variableRowHeight="true">
							
							<!--
							selectionColor="{riskFactorSubTypes.selectedItem == model.vitalSigns[6] ? 0x000000 : riskFactorSubTypes.selectedIndex % 2 == 0 ? 0x3C3C3B : 0x4A4A49}"
							dragEnabled="true" dropEnabled="true" dragMoveEnabled="true" dragComplete="controller.updateVitalIndices()"
							-->
							
							<ASclasses:columns>
								
								<mx:DataGridColumn dataField="name">
									
									<mx:itemRenderer>
										
										<fx:Component>
											
											<mx:HBox verticalAlign="middle" paddingLeft="20" horizontalGap="20" height="161" horizontalScrollPolicy="off" verticalScrollPolicy="off">
												
												<fx:Script>
													<![CDATA[
														import ASclasses.MyCustomDataTip;
														
														import components.itemrenderers.chart.MyCircleItemRenderer;
														import components.itemrenderers.chart.MyCircleItemRendererOver;
														
														import models.modules.decisionsupport.RiskFactor;
														import models.modules.decisionsupport.RiskFactorUpdate;
														
														import mx.charts.HitData;
														import mx.charts.events.ChartItemEvent;
														import mx.controls.Alert;
														import mx.events.FlexEvent;
														import mx.managers.PopUpManager;
														
														import util.DateFormatters;
														import util.DateUtil;
														
														[Bindable] private var riskFactor:RiskFactor;
														
														[Bindable] private var chartMin:Number;
														[Bindable] private var chartMax:Number;
														[Bindable] private var minDate:Date;
														[Bindable] private var maxDate:Date;
														
														[Bindable] private var  currentUpdate:RiskFactorUpdate;
														[Bindable] private var  previousUpdate:RiskFactorUpdate;
														[Bindable] private var  firstUpdate:RiskFactorUpdate;
														
														override public function set data(value:Object):void 
														{
															super.data = value;
															
															riskFactor = data as RiskFactor;
															
															chart.dataProvider = riskFactor ? riskFactor.updates : null;
															
															//	determine chart min/max
															chartMin = NaN;
															chartMax = NaN;
															
															minDate = null;
															maxDate = null;
															
															for each(var update:RiskFactorUpdate in riskFactor.updates)
															{
																if( update.value )
																{
																	chartMin = !isNaN(chartMin) ? Math.min( update.value, chartMin ) : update.value;
																	chartMax = !isNaN(chartMax) ? Math.max( update.value, chartMax ) : update.value;
																}
																
																if( update.date )
																{
																	minDate = minDate != null && minDate.time < update.date.time ? minDate : update.date;
																	maxDate = maxDate != null && maxDate.time > update.date.time ? maxDate : update.date;
																}
															}
															
															//	get current/last update
															currentUpdate = riskFactor.updates && riskFactor.updates.length ? riskFactor.updates.getItemAt( 0 ) as RiskFactorUpdate : null;
															firstUpdate = riskFactor.updates && riskFactor.updates.length ? riskFactor.updates.getItemAt( riskFactor.updates.length -1 ) as RiskFactorUpdate : null;		
															
															if( currentUpdate && firstUpdate
																&& currentUpdate != firstUpdate )
															{
																currentRiskLevel.text = currentUpdate.value + "%";
																dateText.text = "Increase of " + Math.ceil( (currentUpdate.date.time - firstUpdate.date.time ) / DateUtil.MONTH ) + " months";
															}
															else 
															{
																currentRiskLevel.text = currentUpdate ? outerDocument.controller.getRiskLevelLabel( currentUpdate.riskLevel ) : '';
																dateText.text = currentUpdate ? "on " + DateFormatters.monthShortDayNumberYearFull.format( currentUpdate.date ) : '';
															}
														}	
														
														private function onChartRollOver(event:ChartItemEvent):void 
														{
														}
														
														private function onChartRollOut(event:ChartItemEvent):void 
														{
														}
														
														private function chartChange(event:Event):void
														{
															event.stopImmediatePropagation();
														}
													]]>
												</fx:Script>
												
												<fx:Declarations>
													<fx:Array id="bge">
													</fx:Array>
												</fx:Declarations>
												
												<mx:states>
													<s:State name="expanded" />
													<s:State name="collapsed" />
												</mx:states>
												
												<!--	risk factor name	-->
												<s:HGroup width="140">
													<general:MainLinkButton
														label="{riskFactor.name}" 
														icon.expanded="@Embed(source='/images/smallArrow.png')" icon.collapsed="@Embed(source='/images/smallArrowCollapsed.png')" 
														horizontalGap="10" fontSize="13" fontWeight="bold" toggle="true" styleName="linkButtonStyle5" 
														click="{outerDocument.riskFactor = riskFactor}" />
												</s:HGroup>
												
												<s:VGroup width="430" visible="{riskFactor.quantifiable}" includeInLayout="{riskFactor.quantifiable}">
													
													<mx:LineChart 
														id="chart" 
														width="430" height="100" paddingLeft="10" paddingTop="10" paddingRight="10" paddingBottom="10" 
														backgroundElements="{bge}" seriesFilters="[]" selectionMode="single" 
														itemRollOver="onChartRollOver(event)" itemRollOut="onChartRollOut(event)" 
														change="chartChange(event)" >
														
														<mx:series>
															
															<mx:LineSeries yField="value" xField="date" interactive="false">
																<mx:lineStroke>
																	<s:SolidColorStroke color="0x86888A" weight="2" alpha=".5" />
																</mx:lineStroke>
															</mx:LineSeries>
															
															<mx:LineSeries id="myLineSeries" yField="value" xField="date" itemRenderer="mx.charts.renderers.BoxItemRenderer" radius="8" adjustedRadius="8" fillFunction="{outerDocument.controller.fillFunction}" selectedIndex="0">
																<mx:lineStroke>
																	<s:SolidColorStroke color="0xFFFFFF" weight="3" />
																</mx:lineStroke>
																<mx:stroke>
																	<mx:SolidColorStroke color="0xFFFFFF" weight="1"/>
																</mx:stroke>
															</mx:LineSeries>
															
														</mx:series>
														
														<mx:horizontalAxis>
															<mx:DateTimeAxis id="xaxis" minimum="{minDate}" maximum="{maxDate}" />
														</mx:horizontalAxis>
														
														<mx:horizontalAxisRenderers>
															<mx:AxisRenderer axis="{xaxis}" showLabels="false" tickPlacement="none" showLine="false" visible="false"  />
														</mx:horizontalAxisRenderers>
														
														<mx:verticalAxis>
															<mx:LinearAxis id="yaxis" minimum="{chartMin}" maximum="{chartMax}"  />
														</mx:verticalAxis>
														
														<mx:verticalAxisRenderers>
															<mx:AxisRenderer axis="{yaxis}" showLabels="false" tickPlacement="none" showLine="false" visible="false" />
														</mx:verticalAxisRenderers>
														
													</mx:LineChart>
													
												</s:VGroup>
												
												<s:DataGroup width="430" dataProvider="{riskFactor.types}" visible="{!riskFactor.quantifiable}" includeInLayout="{!riskFactor.quantifiable}"> 
													
													<s:layout>
														<s:VerticalLayout />
													</s:layout> 
													
													<s:itemRenderer>
														
														<fx:Component>
															
															<mx:HBox width="100%">
																<fx:Script>
																	<![CDATA[
																		import enum.RiskLevel;
																		
																		import models.modules.decisionsupport.RiskFactor;
																		import models.modules.decisionsupport.RiskFactorUpdate;
																		
																		[Bindable] private var riskFactor:RiskFactor;
																		[Bindable] private var update:RiskFactorUpdate;
																		
																		override public function set data(value:Object):void 
																		{
																			super.data = value;
																			
																			riskFactor = data as RiskFactor;
																			
																			update = riskFactor && riskFactor.updates && riskFactor.updates.length ? riskFactor.updates.getItemAt(0) as RiskFactorUpdate : null;
																		}
																		
																	]]>
																</fx:Script>
																
																<s:Label text="{riskFactor.name}" width="150" styleName="italic" fontSize="13" />
																
																<s:HGroup width="100%" visible="{update!=null}" gap="5" horizontalAlign="right">
																	<s:Label text="{outerDocument.outerDocument.controller.getRiskLevelLabel( update.riskLevel )}" styleName="italic {update.riskLevel == RiskLevel.HIGH ? 'decisionSupportModuleRiskLevelHigh' : 'decisionSupportModuleRiskLevelLow'}" fontSize="13" />
																	<s:Label text="{'due to ' + update.reason + '.'}" styleName="italic" fontSize="13" />
																</s:HGroup>
																
															</mx:HBox>
															
														</fx:Component>
														
													</s:itemRenderer>
													
												</s:DataGroup>
												
												<s:VGroup width="110">
													
													<s:HGroup verticalAlign="bottom">
														<s:Label id="currentRiskLevel" styleName="emphasizedNumber bold" fontSize="36" />
														<s:Label text="risk" fontSize="13" styleName="decisionSupportModuleRiskLevelStatText italic" paddingBottom="5" />
													</s:HGroup>
													
													<s:Label text="{riskFactor.types.length} Risk factors" fontSize="13" styleName="decisionSupportModuleRiskLevelStatText italic" />
													<s:Label id="dateText" fontSize="13" styleName="decisionSupportModuleRiskLevelStatText italic" />
													
												</s:VGroup>
												
											</mx:HBox>
											
										</fx:Component>
										
									</mx:itemRenderer>
									
								</mx:DataGridColumn>
								
							</ASclasses:columns>
							
						</ASclasses:RowColorDataGrid>
						
					</s:VGroup>
					
				</s:NavigatorContent>
				
			</mx:ViewStack>
			
		</s:BorderContainer>
		
	</s:HGroup>
	
</s:VGroup>
